## [ENG] OC_Lettings: Scale a Django Application Using Modular Architecture

Orange County Lettings Website

## Local setup

### Prerequisites

- GitHub account with access to this repository
- Git CLI
- SQLite3 CLI
- Python Interpréter >= 3.6

We assume that the `python` command launches Python Interpreter from OS shell (unless you have activated a virtual environment).

### macOS / Linux

#### Clone repository

- `cd /path/to/put/project/in`
- `git clone https://github.com/OpenClassrooms-Student-Center/Python-OC-Lettings-FR.git`

#### Create virtual environment

- `cd /path/to/Python-OC-Lettings-FR`
- `python -m venv venv`
- `apt-get install python3-venv` (If the previous command returns a « package not found » error on Ubuntu)
- Activate your virtual environment `source venv/bin/activate`
- Once your virtual environment activated, you can check that the `python` command launches Python interpreter in your virtual environment: `which python`
- You can also check Python Interpreter version (>=3.6): `python --version`
- Finally, you can check that the `pip` command launches pip executable in your virtual environment: `which pip`
- Enter the command `deactivate` to deactivate your virtual environment.

#### Run website

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `pip install --requirement requirements.txt`
- `python manage.py runserver`
- Go to `http://localhost:8000` in your browser.
- You can check that the website is correctly running (you should have access to several profiles and locations).

#### Linting

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `flake8`

#### Unit Tests

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `pytest`

#### Database

- `cd /path/to/Python-OC-Lettings-FR`
- Open a shell session `sqlite3`
- Establish a connection to the database `.open oc-lettings-site.sqlite3`
- Print database tables `.tables`
- Print columns in the profiles table, `pragma table_info(Python-OC-Lettings-FR_profile);`
- Launch a query for profiles table `select user_id, favorite_city from
  Python-OC-Lettings-FR_profile where favorite_city like 'B%';`
- Quit shell session `.quit`

#### Admin page

- Go to `http://localhost:8000/admin`
- Login with username `admin` and password `Abc1234!`

### Windows

The actions above can be run from PowerShell, except for the following steps:

- To activate virtual environment, `.\venv\Scripts\Activate.ps1` 
- Replace `which <my-command>` with `(Get-Command <my-command>).Path`

## Deployment

### Setup
- [DockerHub](https://hub.docker.com/signup) Account (containerization)
- [Heroku](https://signup.heroku.com/) Account (deployment)
- [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli#download-and-install) (download locally)
- [CircleCI](https://circleci.com/signup/) Account (CI/CD Pipeline)
- [Sentry](https://sentry.io/signup/) Account (error monitoring)

### CI/CD Pipeline
- A CI/CD Pipeline introduces monitoring and automation for the development of an application, notably at the integration and testing phases, as well as during deployment.
- The CI/CD Pipeline created for this project has been realized with CircleCI.
- The Pipeline encompasses a series of jobs including :
	- A linting and testing job ;
	- A containerization job ;
	- A deployment-production job.
- The jobs are run in the aforementioned order. A job is started only after the previous ones have been successfully completed.
- Jobs are executed only on the main branch of the repository. 
- To create a pipeline for an existing project:
    - Select “Projects”  in the head menu of your CircleCI profile. The page lists all your GitHub Projects;
    - Select “Set Up Project” to start a pipeline for a project.  
- Proper running of a pipeline requires the creation of « environment variables » in order to user the accounts previously created (Docker, Heroku, Sentry). 
- The environment variables created for this project are manyfold :
	- DOCKER_LOGIN : Docker account username ;
	- DOCKER_PWD : Docker account password ;
	- PROJECT_NAME : project name to build a Docker image. The image will be named DOCKER_LOGIN/PROJECT_NAME ; 
	- HEROKU_APP : name of the application deployed on Heroku ;
	- HEROKU_TOKEN : Heroku Token. The token can be obtained with the command `heroku auth :token`
	- SECRET_KEY : Django Secret Key. Be careful not to provide Django default key. A secret key can be generated from terminal with the commands: `from django.core.management.utils import get_random_secret_key`
then `print(get_random_secret_key())`
  - SENTRY_DSN : ID automatically generated by Sentry for your Django project. To find your Sentry DSN (Data Source Name), select “Settings” in the head menu of your Sentry profile, select “Projects” then select your project. Head to the “Security Token” field to retrieve the ID. 

## Using a Docker image locally
- After the containerization job of the CI/CD pipeline is completed, a Docker image is created on Docker Hub. To retrieve the image and run it locally, launch the following command from your terminal (run as Administrator for Git Bash):
`docker run --pull always -p 8000:8000 --name <container_name> <image_name>:<image_tag> `
- To retrieve an image tag, search the image on Docker Hub then select “Tag” on the image’s page.

***
## [FR] OC_Lettings: Mettez à l’échelle une application Django en utilisant une architecture modulaire

Site web d'Orange County Lettings

## Développement local

### Prérequis

- Compte GitHub avec accès en lecture à ce repository
- Git CLI
- SQLite3 CLI
- Interpréteur Python, version 3.6 ou supérieure

Dans le reste de la documentation sur le développement local, il est supposé que la commande `python` de votre OS shell exécute l'interpréteur Python ci-dessus (à moins qu'un environnement virtuel ne soit activé).

### macOS / Linux

#### Cloner le repository

- `cd /path/to/put/project/in`
- `git clone https://github.com/OpenClassrooms-Student-Center/Python-OC-Lettings-FR.git`

#### Créer l'environnement virtuel

- `cd /path/to/Python-OC-Lettings-FR`
- `python -m venv venv`
- `apt-get install python3-venv` (Si l'étape précédente comporte des erreurs avec un paquet non trouvé sur Ubuntu)
- Activer l'environnement `source venv/bin/activate`
- Confirmer que la commande `python` exécute l'interpréteur Python dans l'environnement virtuel
`which python`
- Confirmer que la version de l'interpréteur Python est la version 3.6 ou supérieure `python --version`
- Confirmer que la commande `pip` exécute l'exécutable pip dans l'environnement virtuel, `which pip`
- Pour désactiver l'environnement, `deactivate`

#### Exécuter le site

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `pip install --requirement requirements.txt`
- `python manage.py runserver`
- Aller sur `http://localhost:8000` dans un navigateur.
- Confirmer que le site fonctionne et qu'il est possible de naviguer (vous devriez voir plusieurs profils et locations).

#### Linting

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `flake8`

#### Tests unitaires

- `cd /path/to/Python-OC-Lettings-FR`
- `source venv/bin/activate`
- `pytest`

#### Base de données

- `cd /path/to/Python-OC-Lettings-FR`
- Ouvrir une session shell `sqlite3`
- Se connecter à la base de données `.open oc-lettings-site.sqlite3`
- Afficher les tables dans la base de données `.tables`
- Afficher les colonnes dans le tableau des profils, `pragma table_info(Python-OC-Lettings-FR_profile);`
- Lancer une requête sur la table des profils, `select user_id, favorite_city from
  Python-OC-Lettings-FR_profile where favorite_city like 'B%';`
- `.quit` pour quitter

#### Panel d'administration

- Aller sur `http://localhost:8000/admin`
- Connectez-vous avec l'utilisateur `admin`, mot de passe `Abc1234!`

### Windows

Utilisation de PowerShell, comme ci-dessus sauf :

- Pour activer l'environnement virtuel, `.\venv\Scripts\Activate.ps1` 
- Remplacer `which <my-command>` par `(Get-Command <my-command>).Path`

## Déploiement

### Prérequis
- Compte [DockerHub](https://hub.docker.com/signup) (conteneurisation)
- Compte [Heroku](https://signup.heroku.com/) (déploiement)
- [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli#download-and-install) (à télécharger en local)
- Compte [CircleCI](https://circleci.com/signup/) (pipeline CI/CD)
- Compte [Sentry](https://sentry.io/signup/) (suivi des erreurs)

### Pipeline CI/CD
- Un pipeline CI/CD permet de surveiller et d’automatiser le développement d’une application, en particulier lors des phases d’intégration, de test ou de déploiement.
- Pour ce projet, le pipeline CI/CD est réalisé à l’aide de CircleCI.
- Le pipeline recouvre un ensemble de « travaux » (*jobs*) dont :
	- Un travail de *linting* et de tests ;
	- Un travail de conteneurisation ;
	- Un travail de déploiement-mise en production.
- Les travaux sont exécutés dans l’ordre mentionné ci-dessus ; un travail n’est commencé qu’une fois les précédents terminés avec succès.
- Les travaux ne sont exécutés que sur les branches main du repo. 
- Pour créer un pipeline pour un projet existant:
    - Sélectionner « Projects » dans le menu principal de votre profil CircleCI. La page affiche l’ensemble de vos projets Github;
    - Cliquer sur « Set Up Project » pour commencer un pipeline pour le projet souhaité.  
- Pour s’exécuter correctement, le pipeline doit comprendre un ensemble de « variables d’environnement » permettant l’utilisation des comptes créés ci-dessus (Docker, Heroku, Sentry). 
- Les variables enregistrées pour notre pipeline sont les suivantes :
	- DOCKER_LOGIN : login pour le compte Docker ;
	- DOCKER_PWD : mot de passe pour le compte Docker ;
	- PROJECT_NAME : nom du projet permettant la construction de l’image Docker. L’image aura pour nom DOCKER_LOGIN/PROJECT_NAME ; 
	- HEROKU_APP : nom de l’application déployée sur Heroku ;
	- HEROKU_TOKEN : token Heroku. Ce dernier peut être obtenu par la commande `heroku auth :token`
	- SECRET_KEY : clé secrète Django. Attention à ne pas utiliser la clé fournie par défaut sur l’application Django. Une clé peut être générée depuis le terminal *via* les commandes : `from django.core.management.utils import get_random_secret_key`
puis `print(get_random_secret_key())`
	- SENTRY_DSN : Identifiant automatiquement fourni par Sentry pour le suivi d’un projet Django. Pour retrouver l’identifiant, cliquez sur « Settings » dans le menu principal de votre compte Sentry, sélectionner « Projets » puis sélectionner votre projet. Les informations relatives au projet comporte un champ « Security Token ». 

## Utilisation de votre image Docker en local
- À l’issue du travail de conteneurisation, une image est créée sur Docker Hub. Pour charger l’image et l’exécuter en local, lancer depuis votre terminal la commande (en mode Administrateur pour Git Bash):
`docker run --pull always -p 8000:8000 --name <nom_conteneur> <nom_image>:<tag_image> `
- Pour connaître le tag d’une image, chercher l’image sur Docker Hub puis cliquer sur « Tag » sur la page relative à l’image.
